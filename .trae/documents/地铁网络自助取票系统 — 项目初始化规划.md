## 项目目标与范围
- 目标：通过手机端购票 + 取票机扫码快速出票，缓解高峰期排队。
- 范围：两端 Web（手机端、取票机端），一个后端，MySQL 存储；演示级可用、可扩展。

## 系统角色与端
- 手机端（Mobile Web）：查线、购票、支付、生成二维码凭证。
- 取票机端（Kiosk Web）：摄像头扫码、后端验证、提示出票成功。
- 后端（Spring Boot）：REST API、订单/票务/二维码、票价计算、支付模拟。

## 架构总览
- 前端：Vue 3 + Vite + Element Plus + Axios + qrcode.js + jsQR + ECharts。
- 后端：Java 17 + Spring Boot + MyBatis-Plus + MySQL 8.0 + Lombok + Maven。
- 部署：单库单后端进程，两前端静态资源；同源或通过反向代理处理 CORS。
- 拆分：
  - mobile-spa（手机端）
  - kiosk-spa（取票机端）
  - backend-api（REST 服务）

## 核心业务流程
- 手机购票：选择起点/终点 → 后端计算票价 → 模拟支付 → 生成订单与二维码 → 手机展示二维码。
- 取票机出票：取票机摄像头扫码 → 后端验证订单有效性（未使用、未过期、已支付）→ 标记已出票 → 前端提示成功。

## 数据模型设计（表与关键字段）
- station：`id, name, line_id, code, is_active`
- line：`id, name, color, code, is_active`
- line_station（线与站的关系，含顺序）：`id, line_id, station_id, seq`
- fare_rule（票价规则，演示可简化）：`id, rule_type, base_price, per_segment_price`
- order：`id, user_id(optional), from_station_id, to_station_id, price, status, created_at`
- ticket：`id, order_id, qrcode_token_id, issued_at, status`
- qrcode_token：`id, order_id, nonce, expires_at, signature, payload`
- payment：`id, order_id, amount, status, paid_at, channel`
- 用户表可后置（演示匿名），或以 `user_id` 为空表示游客。
- 状态机：
  - order：`CREATED → PAID → ISSUED`（取消：`CANCELLED`）
  - ticket：`INIT → VALIDATED → DISPENSED`
  - payment：`PENDING → SUCCESS/FAILED`

## 二维码规范（演示安全足够）
- 载荷（JSON）：`{ orderId, nonce, exp, sign }`
- `sign`：服务端基于 `orderId + nonce + exp` 的 HMAC-SHA256（服务端密钥）。
- `exp`：过期时间（例如生成后 15 分钟）。
- 手机端生成二维码图像使用 `qrcode.js`；签名由后端生成并返回。

## 票价计算规则（演示）
- 简化：基于站点距离（同线段数）或统一基础价 + 每段加价。
- 支持跨线换乘：通过 `line_station.seq` 计算最短路径（演示可先用同线直达 + 简单换乘一次）。

## 后端 API 设计（REST）
- 线路与站点：
  - `GET /api/lines`：线路列表
  - `GET /api/stations?lineId=`：站点列表
  - `GET /api/map`：完整线路图数据（供 ECharts）
- 票价与订单：
  - `GET /api/fares/quote?from=&to=`：返回价格与路径摘要
  - `POST /api/orders`：创建订单（含起止站）
  - `POST /api/payments/mock`：模拟支付（入参：`orderId`）
  - `GET /api/orders/{id}/qrcode`：返回二维码载荷（`nonce, exp, sign`）
- 取票机验证与出票：
  - `POST /api/kiosk/validate`：入参二维码载荷，返回订单有效性与可出票状态
  - `POST /api/tickets/issue`：入参 `orderId` 或 `tokenId`，幂等标记为已出票

## 安全与风控
- HMAC 签名（服务端密钥），二维码短时效（15 分钟）。
- 幂等：`/tickets/issue` 幂等处理（重复请求不重复出票）。
- 速率限制：对 `validate` 与 `issue` 做基础频控（演示级）。
- CORS：仅允许前端域名；生产使用 HTTPS。

## 前端页面与组件
- 手机端：
  - 线路图页：ECharts 渲染地铁图，可选站点。
  - 购票页：起点/终点选择、价格展示、下单。
  - 支付页：模拟支付成功。
  - 凭证页：二维码展示（`qrcode.js`）。
- 取票机端：
  - 扫码页：摄像头取流 + `jsQR` 识别二维码。
  - 出票结果页：验证通过提示成功/失败原因。
- 共享：
  - `axios` 封装、错误处理、加载态、主题（Element Plus）。

## 三人分工（建议）
- A（后端）：数据模型、票价计算、订单与支付、二维码签名 API、幂等与状态机。
- B（手机端）：线路图与选站、下单与支付、二维码展示、API 对接。
- C（取票机端）：摄像头扫码、二维码解析、验证与出票流程、UX 提示。

## 工程初始化步骤（通过脚手架）
- 后端：
  - 创建 Spring Boot 项目，依赖：`spring-boot-starter-web`, `mybatis-plus-boot-starter`, `mysql-connector-j`, `lombok`。
  - 配置 `application.yml`（数据源、MyBatis-Plus、端口）。
  - 初始化表结构 SQL（开发库）。
- 手机端与取票机端：
  - `npm create vite@latest mobile -- --template vue`
  - `npm create vite@latest kiosk -- --template vue`
  - 安装：`element-plus`, `axios`, `qrcode`, `jsqr`, `echarts`。
  - 基础路由与页面骨架、Axios 基础封装。

## 里程碑与验收
- M1（1-2 天）：后端项目骨架 + 两端项目初始化，ECharts 地铁图静态数据。
- M2（2-3 天）：票价 API、下单与支付、二维码展示与签名。
- M3（2-3 天）：取票机扫码、验证与出票、状态机与幂等。
- 演示验收：
  - 手机端完成购票，展示二维码。
  - 取票机端扫码验证并提示出票成功。

## 风险与备选方案
- 摄像头权限受限：提供本地上传二维码图片做兜底。
- 路径计算复杂：初版简化（同线或一次换乘），后续迭代为最短路径算法。
- ECharts 地铁图复杂：初版静态示例，逐步完善交互。

---
确认后我将直接初始化后端与两端项目骨架，并提交基础数据结构与 API 雏形。